#!/bin/sh
################################################################################
# ORBITAL OS INIT SCRIPT - Enhanced Minimal Version
#
# Purpose: Lightweight init script for Orbic Speed (RC400L) native root access
#          Reflects Phase 2 reality: Primary access via 'adb shell su' (Front Door)
#          Backdoor is optional fallback only
#
# Location: /data/rayhunter/orbital_os_init.sh
#
# Author: FOLC-V3 Project
# Version: 2.0 (Enhanced Minimal)
# Date: January 2026
#
# Usage:
#   orbital_os_init.sh start   - Start Orbital OS services
#   orbital_os_init.sh stop    - Stop Orbital OS services
#   orbital_os_init.sh status  - Check service status
#
################################################################################

ALPINE_ROOT="/data/alpine"
SYMLINK_BRIDGE="/data/rayhunter/symlink_bridge.sh"
BACKDOOR_PORT=9999
LOG="/data/rayhunter/orbital_os.log"

# Simple logging function with timestamps
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG"
}

case "$1" in
  start)
    log "Starting Orbital OS Services..."
    
    # Mount Alpine filesystems
    if [ ! -d "$ALPINE_ROOT" ]; then
        log "ERROR: Alpine root not found at $ALPINE_ROOT"
        exit 1
    fi
    
    if mount -t proc proc "$ALPINE_ROOT/proc" 2>/dev/null; then
        log "Mounted /proc"
    else
        log "ERROR: Failed to mount /proc at $ALPINE_ROOT/proc"
    fi
    if mount -t sysfs sys "$ALPINE_ROOT/sys" 2>/dev/null; then
        log "Mounted /sys"
    else
        log "ERROR: Failed to mount /sys at $ALPINE_ROOT/sys"
    fi
    if mount -o bind /dev "$ALPINE_ROOT/dev" 2>/dev/null; then
        log "Mounted /dev"
    else
        log "ERROR: Failed to bind-mount /dev at $ALPINE_ROOT/dev"
    fi
    
    # Setup symlink bridge
    if [ -x "$SYMLINK_BRIDGE" ]; then
        if "$SYMLINK_BRIDGE" setup >> "$LOG" 2>&1; then
            log "Symlink bridge configured"
        else
            log "WARNING: Symlink bridge setup encountered issues"
        fi
    fi
    
    # Optional: Backdoor (redundant with 'adb shell su' front door)
    if ! netstat -tlpn 2>/dev/null | grep -q ":$BACKDOOR_PORT "; then
        (while true; do /bin/busybox nc -ll -p $BACKDOOR_PORT -e /bin/sh 2>/dev/null; sleep 1; done) &
        log "Backdoor started on port $BACKDOOR_PORT (optional fallback)"
    fi
    
    # Start FOLC UI (non-blocking)
    if [ -x /data/rayhunter/start_folc_v2.sh ]; then
        /data/rayhunter/start_folc_v2.sh >> "$LOG" 2>&1 &
        log "FOLC UI launch script invoked (background)"
    fi
    
    log "Orbital OS initialization complete"
    ;;
    
  stop)
    log "Stopping Orbital OS Services..."
    
    # Stop processes
    if command -v killall >/dev/null 2>&1; then
        if killall -q nc python3 >>"$LOG" 2>&1; then
            log "Stopped backdoor and UI processes"
        else
            log "WARNING: Failed to stop backdoor and UI processes via killall"
        fi
    else
        log "WARNING: killall command not found; unable to stop backdoor and UI processes automatically"
    fi
    
    # Cleanup symlink bridge
    if [ -x "$SYMLINK_BRIDGE" ]; then
        if "$SYMLINK_BRIDGE" cleanup >> "$LOG" 2>&1; then
            log "Symlink bridge cleaned up"
        else
            log "WARNING: Symlink bridge cleanup encountered issues"
        fi
    fi
    
    # Unmount Alpine filesystems
    umount "$ALPINE_ROOT/dev" 2>/dev/null
    umount "$ALPINE_ROOT/sys" 2>/dev/null
    umount "$ALPINE_ROOT/proc" 2>/dev/null
    log "Alpine filesystems unmounted"
    
    log "Orbital OS services stopped"
    ;;
    
  status)
    echo "=========================================="
    echo "Orbital OS Status"
    echo "=========================================="
    echo ""
    echo "Alpine Mounts:"
    mount | grep "$ALPINE_ROOT" || echo "  No mounts found"
    echo ""
    echo "Backdoor (optional fallback):"
    netstat -tlpn 2>/dev/null | grep "$BACKDOOR_PORT" || echo "  Not running"
    echo ""
    echo "FOLC UI:"
    ps | grep "[f]olc" || echo "  Not running"
    echo ""
    echo "Symlink Bridge:"
    if [ -x "$SYMLINK_BRIDGE" ]; then
        "$SYMLINK_BRIDGE" status 2>/dev/null
    else
        echo "  Script not found"
    fi
    echo "=========================================="
    ;;
    
  *)
    echo "Usage: $0 {start|stop|status}"
    echo ""
    echo "Commands:"
    echo "  start  - Start Orbital OS services"
    echo "  stop   - Stop Orbital OS services"
    echo "  status - Check service status"
    echo ""
    echo "Note: Primary root access is via 'adb shell su' (Front Door)"
    echo "      Backdoor on port $BACKDOOR_PORT is optional fallback only"
    exit 1
    ;;
esac

exit 0
