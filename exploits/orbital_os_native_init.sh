#!/bin/sh
### BEGIN INIT INFO
# Provides:          orbital_os
# Required-Start:    $local_fs
# Required-Stop:     $local_fs
# Default-Start:     S
# Default-Stop:      0 6
# Short-Description: Orbital OS Native Root Services
### END INIT INFO

ALPINE_ROOT="/data/alpine"
SYMLINK_BRIDGE="/data/rayhunter/symlink_bridge.sh"
BACKDOOR_PORT=9999

case "$1" in
  start)
    echo "Starting Orbital OS Services..."
    
    # Mount Alpine
    [ -d "$ALPINE_ROOT" ] || exit 0
    mount -t proc proc "$ALPINE_ROOT/proc" 2>/dev/null
    mount -t sysfs sys "$ALPINE_ROOT/sys" 2>/dev/null
    mount -o bind /dev "$ALPINE_ROOT/dev" 2>/dev/null
    
    # Symlink Bridge
    if [ -x "$SYMLINK_BRIDGE" ]; then
        "$SYMLINK_BRIDGE" setup
    fi
    
    # Backdoor (Non-blocking)
    if ! netstat -tlpn | grep -q ":$BACKDOOR_PORT "; then
        (while true; do /bin/busybox nc -ll -p $BACKDOOR_PORT -e /bin/sh; sleep 1; done) &
    fi
    
    # FOAC UI (Non-blocking)
    if [ -x /data/rayhunter/start_foac_v2.sh ]; then
        /data/rayhunter/start_foac_v2.sh &
    fi
    ;;
  stop)
    echo "Stopping Orbital OS Services..."
    # Cleanup symlinks
    if [ -x "$SYMLINK_BRIDGE" ]; then
        "$SYMLINK_BRIDGE" cleanup
    fi
    # Unmount (optional, safer to leave if UI is running)
    ;;
  *)
    echo "Usage: $0 {start|stop}"
    exit 1
    ;;
esac

exit 0
